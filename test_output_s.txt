============================= test session starts =============================
platform win32 -- Python 3.11.9, pytest-8.4.2, pluggy-1.6.0 -- C:\Users\sanal\AppData\Local\Programs\Python\Python311\python.exe
cachedir: .pytest_cache
PySide6 6.7.2 -- Qt runtime 6.7.2 -- Qt compiled 6.7.2
rootdir: D:\github\DocuFlow-
plugins: anyio-4.3.0, asyncio-1.2.0, mock-3.15.0, qt-4.5.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 1 item

backend/tests/test_gnc_fidelity.py::test_gnc_multi_part_nesting 
Source part has 10 contours
  Contour 0: 1 commands
  Contour 1: 17 commands
  Contour 2: 16 commands
  Contour 3: 13 commands
  Contour 4: 14 commands
  Contour 5: 14 commands
  Contour 6: 13 commands
  Contour 7: 14 commands
  Contour 8: 16 commands
  Contour 9: 16 commands
Generated 18 contour lines
FAILED

================================== FAILURES ===================================
_________________________ test_gnc_multi_part_nesting _________________________

    def test_gnc_multi_part_nesting():
        """
        Test placing two parts with different positions and verify renumbering and offsets.
        """
        if not os.path.exists(SAMPLE_PATH):
            pytest.skip("Sample GNC file not found")
    
        with open(SAMPLE_PATH, "r", encoding="utf-8") as f:
            content = f.read()
    
        parser = GNCParser()
        # Extract just one part from the sample to use as a template
        full_sheet = parser.parse(content)
        if not full_sheet.parts:
            pytest.skip("No parts found in sample")
    
        source_part = full_sheet.parts[0]
    
        # Create a new sheet with 2 instances of this part
        from backend.gnc_parser import GNCSheet, GNCPart
        import copy
    
        new_sheet = GNCSheet(
            name="Test Multi-Part",
            program_width=3000,
            program_height=1500,
            thickness=1.5,
            header_commands=full_sheet.header_commands[:5] # Keep some headers
        )
    
        # Part 1 at (0, 0)
        p1 = copy.deepcopy(source_part)
        p1.x = 0
        p1.y = 0
    
        # Part 2 at (500, 200)
        p2 = copy.deepcopy(source_part)
        p2.x = 500
        p2.y = 200
    
        new_sheet.parts = [p1, p2]
    
        generator = GNCGenerator()
        generated = generator.generate(new_sheet)
        lines = generated.splitlines()
    
        # Verification 1: Count contours
        n_source_contours = len(source_part.contours)
        print(f"\nSource part has {n_source_contours} contours")
        for i, c in enumerate(source_part.contours):
            print(f"  Contour {i}: {len(c.commands)} commands")
    
        contour_lines = [l for l in lines if "(==== CONTOUR" in l]
        print(f"Generated {len(contour_lines)} contour lines")
    
>       assert len(contour_lines) == 2 * n_source_contours, f"Expected {2*n_source_contours} contours, got {len(contour_lines)}"
E       AssertionError: Expected 20 contours, got 18
E       assert 18 == (2 * 10)
E        +  where 18 = len(['(==== CONTOUR  1 ====)', '(==== CONTOUR  2 ====)', '(==== CONTOUR  3 ====)', '(==== CONTOUR  4 ====)', '(==== CONTOUR  5 ====)', '(==== CONTOUR  6 ====)', ...])

backend\tests\test_gnc_fidelity.py:63: AssertionError
=========================== short test summary info ===========================
FAILED backend/tests/test_gnc_fidelity.py::test_gnc_multi_part_nesting - Asse...
============================== 1 failed in 0.42s ==============================
