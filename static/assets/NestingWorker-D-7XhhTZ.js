(function(){"use strict";self.onmessage=function(n){const{type:e,payload:s}=n.data;if(e==="START_NESTING"){const{sheets:t,inventory:i,stock:h,config:l}=s,M=l.nestingMode||"hull",u=l.spacing!==void 0?l.spacing:5,x=l.rotations||4;console.log("Worker: START_NESTING received",{sheetsCount:t.length,inventorySize:i.length,multiSheet:l.multiSheet,mode:M,rotations:x});let w=[];i.forEach(c=>{const g=C(c);if(M==="hull"&&!g.isClosed){console.warn(`Worker: Part ${c.name} could not be closed after welding. Skipping in 'hull' mode.`);return}for(let o=0;o<c.remaining;o++)w.push({...c,width:g.width||c.width||100,height:g.height||c.height||100,polygon:g.polygon||null,minX:g.minX||0,minY:g.minY||0,originalRef:c,instanceId:o})}),console.log(`Worker: Prepared ${w.length} parts to place.`),w.sort((c,g)=>g.width*g.height-c.width*c.height);let m=JSON.parse(JSON.stringify(t)),p=[],Y=w.length,X=0;if(Y===0){console.warn("Worker: No valid parts to place."),self.postMessage({type:"COMPLETE",payload:{sheets:m,parts:[]}});return}for(let c of w){let g=!1;const o=360/x;for(let a=0;a<x;a++){const r=a*o;let y=c;if(r!==0){const f=A(c.polygon,r);if(f){const d=N(f),P=f.map(E=>({x:E.x-d.minX,y:E.y-d.minY}));y={...c,polygon:P,width:d.width,height:d.height,rotation:r}}}else y.rotation=0;for(let f of m){const d=f.nestingArea||{x:10,y:10,width:(f.width||2e3)-20,height:(f.height||1e3)-20},P=O(y,f,d,u,l);if(P){const E=Math.max(0,...m.flatMap(S=>S.parts||[]).map(S=>S.id),...p.map(S=>S.id))+1,T={...y,id:E,x:P.x,y:P.y,sheetIndex:m.indexOf(f)};f.parts=[...f.parts||[],T],p.push(T),g=!0,console.log(`Worker: Placed ${c.name} at ${P.x.toFixed(1)}, ${P.y.toFixed(1)} with rotation ${r}`);break}}if(g)break}if(!g&&l.multiSheet&&h&&h.length>0){const a=h[0],r={id:m.length,name:`Sheet ${m.length+1}`,width:a.width,height:a.height,parts:[]},y={x:10,y:10,width:r.width-20,height:r.height-20},f=360/x;for(let d=0;d<x;d++){const P=d*f;let E=c;if(P!==0){const S=A(c.polygon,P);if(S){const I=N(S),k=S.map($=>({x:$.x-I.minX,y:$.y-I.minY}));E={...c,polygon:k,width:I.width,height:I.height,rotation:P}}}else E.rotation=0;const T=O(E,r,y,u,l);if(T){const S=Math.max(0,...m.flatMap(k=>k.parts||[]).map(k=>k.id),...p.map(k=>k.id))+1,I={...E,id:S,x:T.x,y:T.y,sheetIndex:m.length};r.parts.push(I),m.push(r),p.push(I),g=!0;break}if(g)break}}g||console.error(`Worker: FAILED to place part ${c.name}`),X++,self.postMessage({type:"PROGRESS",payload:Math.floor(X/Y*100)})}self.postMessage({type:"COMPLETE",payload:{sheets:m,parts:p}})}else if(e==="STOP_NESTING")self.postMessage({type:"STOPPED"});else if(e==="ANALYZE_SHEET"){const{sheet:t}=s;console.log("Worker: Analysis started for sheet",t.id);const i=t.parts.map(h=>{const l=C(h);return{...h,width:l.width||h.width||0,height:l.height||h.height||0,polygon:l.polygon||null,minX:l.minX||0,minY:l.minY||0,analysisComplete:!0}});self.postMessage({type:"ANALYSIS_COMPLETE",payload:{sheetId:t.id,parts:i}})}};function C(n){if(!n.contours)return{isClosed:!1};let e=[];if(n.contours.forEach(o=>{let a=null,r=null;o.commands.forEach(y=>{const f=a,d=r;y.x!==void 0&&(a=y.x),y.y!==void 0&&(r=y.y),f!==null&&a!==null&&(f!==a||d!==r)&&e.push({x1:f,y1:d,x2:a,y2:r})})}),e.length===0)return{isClosed:!1};const s=2;let t=[],i=[];function h(o,a){for(let r=0;r<i.length;r++)if(W(o,a,i[r].x,i[r].y)<s)return r;return i.push({x:o,y:a}),i.length-1}e.forEach(o=>{const a=h(o.x1,o.y1),r=h(o.x2,o.y2);a!==r&&t.push([a,r])});let l=new Array(i.length).fill(0);t.forEach(o=>{l[o[0]]++,l[o[1]]++});let M=!0;for(;M;){M=!1;for(let o=0;o<i.length;o++)if(l[o]===1)for(let a=0;a<t.length;a++){const r=t[a];if(r[0]===o||r[1]===o){l[r[0]]--,l[r[1]]--,t.splice(a,1),M=!0;break}}}let u=new Array(i.length).fill(0).map(()=>[]);t.forEach(o=>{u[o[0]].push(o[1]),u[o[1]].push(o[0])});let x=new Set,w=[];for(let o=0;o<i.length;o++)if(!x.has(o)&&u[o].length>=2){let a=[o],r=u[o][0];for(;r!==void 0&&!x.has(r);){x.add(r),a.push(r);let y=u[r],f=a[a.length-2];if(r=y.find(d=>d!==f),r===o)break}a.length>2&&w.push(a)}if(w.length===0){let o=Math.min(...i.map(f=>f.x)),a=Math.max(...i.map(f=>f.x)),r=Math.min(...i.map(f=>f.y)),y=Math.max(...i.map(f=>f.y));return{isClosed:!1,width:a-o,height:y-r}}let p=w.sort((o,a)=>a.length-o.length)[0].map(o=>i[o]),Y=Math.min(...p.map(o=>o.x)),X=Math.max(...p.map(o=>o.x)),c=Math.min(...p.map(o=>o.y)),g=Math.max(...p.map(o=>o.y));return p=p.map(o=>({x:o.x-Y,y:o.y-c})),{isClosed:!0,width:X-Y,height:g-c,polygon:p,minX:Y,minY:c}}function A(n,e){if(!n)return null;const s=e*Math.PI/180,t=Math.cos(s),i=Math.sin(s);return n.map(h=>({x:h.x*t-h.y*i,y:h.x*i+h.y*t}))}function N(n){if(!n||n.length===0)return{minX:0,minY:0,width:0,height:0};let e=1/0,s=-1/0,t=1/0,i=-1/0;return n.forEach(h=>{h.x<e&&(e=h.x),h.x>s&&(s=h.x),h.y<t&&(t=h.y),h.y>i&&(i=h.y)}),{minX:e,minY:t,width:s-e,height:i-t}}function W(n,e,s,t){return Math.sqrt(Math.pow(n-s,2)+Math.pow(e-t,2))}function O(n,e,s,t,i){const h=n.width,l=n.height,M=5;for(let u=s.y;u<=s.y+s.height-l;u+=M)for(let x=s.x;x<=s.x+s.width-h;x+=M){let w=!1;for(let m of e.parts||[])if(R(x,u,n,m,t,i)){w=!0;break}if(!w)return{x,y:u}}return null}function R(n,e,s,t,i,h){return n+s.width+i<t.x||n>t.x+t.width+i||e+s.height+i<t.y||e>t.y+t.height+i?!1:h.nestingMode==="hull"&&s.polygon&&t.polygon?_(s.polygon.map(l=>({x:l.x+n,y:l.y+e})),t.polygon.map(l=>({x:l.x+t.x,y:l.y+t.y})),i):!0}function _(n,e,s){for(let t=0;t<n.length;t++){const i=n[t],h=n[(t+1)%n.length];for(let l=0;l<e.length;l++){const M=e[l],u=e[(l+1)%e.length];if(z(i,h,M,u))return!0}}if(L(n[0],e)||L(e[0],n))return!0;if(s>0){for(let t=0;t<n.length;t++)if(b(n[t],e)<s)return!0;for(let t=0;t<e.length;t++)if(b(e[t],n)<s)return!0}return!1}function b(n,e){let s=1/0;for(let t=0;t<e.length;t++){const i=e[t],h=e[(t+1)%e.length],l=j(n,i,h);l<s&&(s=l)}return Math.sqrt(s)}function j(n,e,s){const t=(e.x-s.x)**2+(e.y-s.y)**2;if(t===0)return(n.x-e.x)**2+(n.y-e.y)**2;let i=((n.x-e.x)*(s.x-e.x)+(n.y-e.y)*(s.y-e.y))/t;return i=Math.max(0,Math.min(1,i)),(n.x-(e.x+i*(s.x-e.x)))**2+(n.y-(e.y+i*(s.y-e.y)))**2}function z(n,e,s,t){const i=(e.x-n.x)*(t.y-s.y)-(e.y-n.y)*(t.x-s.x);if(i===0)return!1;const h=((t.y-s.y)*(t.x-n.x)+(s.x-t.x)*(t.y-n.y))/i,l=((n.y-e.y)*(t.x-n.x)+(e.x-n.x)*(t.y-n.y))/i;return 0<h&&h<1&&0<l&&l<1}function L(n,e){let s=!1;for(let t=0,i=e.length-1;t<e.length;i=t++)e[t].y>n.y!=e[i].y>n.y&&n.x<(e[i].x-e[t].x)*(n.y-e[t].y)/(e[i].y-e[t].y)+e[t].x&&(s=!s);return s}})();
