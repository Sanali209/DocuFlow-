(function(){"use strict";self.onmessage=function(l){const{type:n,payload:h}=l.data;if(n==="START_NESTING"){const{sheets:t,inventory:s,stock:f,config:r}=h,x=r.nestingMode||"hull";console.log("Worker: START_NESTING received",{sheetsCount:t.length,inventorySize:s.length,multiSheet:r.multiSheet,mode:x});let d=[];s.forEach(a=>{const p=T(a);if(x==="hull"&&!p.isClosed){console.warn(`Worker: Part ${a.name} could not be closed after welding. Skipping in 'hull' mode.`);return}for(let g=0;g<a.remaining;g++)d.push({...a,width:p.width||a.width||100,height:p.height||a.height||100,polygon:x==="hull"?p.polygon:null,originalRef:a,instanceId:g})}),console.log(`Worker: Prepared ${d.length} parts to place.`),d.sort((a,p)=>p.width*p.height-a.width*a.height);let y=JSON.parse(JSON.stringify(t)),w=[],P=d.length,m=0;if(P===0){console.warn("Worker: No valid parts to place."),self.postMessage({type:"COMPLETE",payload:{sheets:y,parts:[]}});return}for(let a of d){let p=!1;for(let g of y){const M=g.nestingArea||{x:10,y:10,width:(g.width||2e3)-20,height:(g.height||1e3)-20},e=E(a,g,M);if(e){const i=Math.max(0,...y.flatMap(u=>u.parts||[]).map(u=>u.id),...w.map(u=>u.id))+1,o={...a,id:i,x:e.x,y:e.y,sheetIndex:y.indexOf(g)};g.parts=[...g.parts||[],o],w.push(o),p=!0,console.log(`Worker: Placed ${a.name} at ${e.x.toFixed(1)}, ${e.y.toFixed(1)}`);break}}if(!p&&r.multiSheet&&f&&f.length>0){const g=f[0],M={id:y.length,name:`Sheet ${y.length+1}`,width:g.width,height:g.height,parts:[]},e={x:10,y:10,width:M.width-20,height:M.height-20},i=E(a,M,e);if(i){const o=Math.max(0,...y.flatMap(c=>c.parts||[]).map(c=>c.id),...w.map(c=>c.id))+1,u={...a,id:o,x:i.x,y:i.y,sheetIndex:y.length};M.parts.push(u),y.push(M),w.push(u),p=!0}}p||console.error(`Worker: FAILED to place part ${a.name}`),m++,self.postMessage({type:"PROGRESS",payload:Math.floor(m/P*100)})}self.postMessage({type:"COMPLETE",payload:{sheets:y,parts:w}})}else n==="STOP_NESTING"&&self.postMessage({type:"STOPPED"})};function T(l){if(!l.contours)return{isClosed:!1};let n=[];if(l.contours.forEach(e=>{let i=null,o=null;e.commands.forEach(u=>{const c=i,S=o;u.x!==void 0&&(i=u.x),u.y!==void 0&&(o=u.y),c!==null&&i!==null&&(c!==i||S!==o)&&n.push({x1:c,y1:S,x2:i,y2:o})})}),n.length===0)return{isClosed:!1};const h=2;let t=[],s=[];function f(e,i){for(let o=0;o<s.length;o++)if(C(e,i,s[o].x,s[o].y)<h)return o;return s.push({x:e,y:i}),s.length-1}n.forEach(e=>{const i=f(e.x1,e.y1),o=f(e.x2,e.y2);i!==o&&t.push([i,o])});let r=new Array(s.length).fill(0);t.forEach(e=>{r[e[0]]++,r[e[1]]++});let x=!0;for(;x;){x=!1;for(let e=0;e<s.length;e++)if(r[e]===1)for(let i=0;i<t.length;i++){const o=t[i];if(o[0]===e||o[1]===e){r[o[0]]--,r[o[1]]--,t.splice(i,1),x=!0;break}}}let d=new Array(s.length).fill(0).map(()=>[]);t.forEach(e=>{d[e[0]].push(e[1]),d[e[1]].push(e[0])});let y=new Set,w=[];for(let e=0;e<s.length;e++)if(!y.has(e)&&d[e].length>=2){let i=[e],o=d[e][0];for(;o!==void 0&&!y.has(o);){y.add(o),i.push(o);let u=d[o],c=i[i.length-2];if(o=u.find(S=>S!==c),o===e)break}i.length>2&&w.push(i)}if(w.length===0){let e=Math.min(...s.map(c=>c.x)),i=Math.max(...s.map(c=>c.x)),o=Math.min(...s.map(c=>c.y)),u=Math.max(...s.map(c=>c.y));return{isClosed:!1,width:i-e,height:u-o}}let m=w.sort((e,i)=>i.length-e.length)[0].map(e=>s[e]),a=Math.min(...m.map(e=>e.x)),p=Math.max(...m.map(e=>e.x)),g=Math.min(...m.map(e=>e.y)),M=Math.max(...m.map(e=>e.y));return m=m.map(e=>({x:e.x-a,y:e.y-g})),{isClosed:!0,width:p-a,height:M-g,polygon:m,minX:a,minY:g}}function C(l,n,h,t){return Math.sqrt(Math.pow(l-h,2)+Math.pow(n-t,2))}function E(l,n,h){const t=l.width,s=l.height,f=5;for(let r=h.y;r<=h.y+h.height-s;r+=5)for(let x=h.x;x<=h.x+h.width-t;x+=5){let d=!1;for(let y of n.parts||[])if(I(x,r,l,y,f)){d=!0;break}if(!d)return{x,y:r}}return null}function I(l,n,h,t,s){return l+h.width+s<t.x||l>t.x+t.width+s||n+h.height+s<t.y||n>t.y+t.height+s?!1:h.polygon&&t.polygon?N(h.polygon.map(f=>({x:f.x+l,y:f.y+n})),t.polygon.map(f=>({x:f.x+t.x,y:f.y+t.y}))):!0}function N(l,n,h){for(let t=0;t<l.length;t++){const s=l[t],f=l[(t+1)%l.length];for(let r=0;r<n.length;r++){const x=n[r],d=n[(r+1)%n.length];if(v(s,f,x,d))return!0}}return!!(k(l[0],n)||k(n[0],l))}function v(l,n,h,t){const s=(n.x-l.x)*(t.y-h.y)-(n.y-l.y)*(t.x-h.x);if(s===0)return!1;const f=((t.y-h.y)*(t.x-l.x)+(h.x-t.x)*(t.y-l.y))/s,r=((l.y-n.y)*(t.x-l.x)+(n.x-l.x)*(t.y-l.y))/s;return 0<f&&f<1&&0<r&&r<1}function k(l,n){let h=!1;for(let t=0,s=n.length-1;t<n.length;s=t++)n[t].y>l.y!=n[s].y>l.y&&l.x<(n[s].x-n[t].x)*(l.y-n[t].y)/(n[s].y-n[t].y)+n[t].x&&(h=!h);return h}})();
